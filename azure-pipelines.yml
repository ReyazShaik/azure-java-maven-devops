trigger:
  - main

pool:
  name: self-hosted-linux   # Your self-hosted agent pool

variables:
  WAR_NAME: myapp.war
  STORAGE_ACCOUNT: cicdartifacts123
  CONTAINER_NAME: artifacts
  SONAR_PROJECT_KEY: hotstar

stages:
- stage: Build_Scan_Publish
  displayName: Build, Scan, and Publish Artifact
  jobs:
  - job: Build
    displayName: Maven Build & SonarQube
    steps:

    # Checkout code
    - checkout: self

    # Install Java 17 automatically from Azure Pipelines
    - task: JavaToolInstaller@0
      displayName: Install Java 17
      inputs:
        versionSpec: '17'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'AzurePipelines'

    # Prepare SonarQube scan
    - task: SonarQubePrepare@8
      inputs:
        SonarQube: 'SonarQube-Service-Connection'
        scannerMode: 'CLI'
        configMode: 'manual'
        cliProjectKey: '$(SONAR_PROJECT_KEY)'
        cliSources: '.'

    # Maven Build + Sonar Scan
    - task: Maven@3
      inputs:
        mavenPomFile: 'pom.xml'
        goals: 'clean package sonar:sonar'
        javaHomeOption: 'JDKVersion'
        jdkVersionOption: '17'
        mavenVersionOption: 'Default'

    # SonarQube Quality Gate
    - task: SonarQubePublish@8
      inputs:
        pollingTimeoutSec: '300'

    # Upload WAR to Azure Blob
    - task: AzureCLI@2
      displayName: Upload WAR to Azure Blob
      inputs:
        azureSubscription: 'Azure-Service-Connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az storage blob upload \
            --account-name $(STORAGE_ACCOUNT) \
            --container-name $(CONTAINER_NAME) \
            --name $(WAR_NAME) \
            --file target/*.war \
            --overwrite

- stage: Deploy
  displayName: Deploy to Tomcat
  dependsOn: Build_Scan_Publish
  jobs:
  - job: DeployToTomcat
    displayName: Download & Deploy WAR
    steps:

    # Download WAR from Azure Blob
    - task: AzureCLI@2
      displayName: Download WAR from Azure Blob
      inputs:
        azureSubscription: 'Azure-Service-Connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          az storage blob download \
            --account-name $(STORAGE_ACCOUNT) \
            --container-name $(CONTAINER_NAME) \
            --name $(WAR_NAME) \
            --file $(WAR_NAME)

    # Copy WAR to Tomcat webapps via SSH
    - task: CopyFilesOverSSH@0
      displayName: Deploy WAR to Tomcat
      inputs:
        sshEndpoint: 'Tomcat-VM-SSH'
        sourceFolder: '$(System.DefaultWorkingDirectory)'
        contents: '$(WAR_NAME)'
        targetFolder: '/apache-tomcat-11.0.15/webapps'
        overwrite: true

    # Restart Tomcat to load the new WAR
    - task: SSH@0
      displayName: Restart Tomcat
      inputs:
        sshEndpoint: 'Tomcat-VM-SSH'
        runOptions: 'commands'
        commands: |
          sudo systemctl restart tomcat
